<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Passwort ändern</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <script src="header.js"></script>
    <style>
        .password-container {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            max-width: 500px;
            margin: 0 auto;
            margin-top: 2rem;
        }

        h1 {
            color: #4f8cff;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .password-strength {
            height: 5px;
            margin-top: 10px;
            border-radius: 3px;
            transition: all 0.3s;
            width: 0;
        }

        .password-strength.weak {
            background-color: #f44336;
            width: 30%;
        }

        .password-strength.medium {
            background-color: #ff9800;
            width: 60%;
        }

        .password-strength.strong {
            background-color: #4CAF50;
            width: 100%;
        }

        .requirements {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .requirements ul {
            margin: 0.5rem 0 0 1.5rem;
            padding: 0;
        }

        .requirement {
            margin-bottom: 0.3rem;
            color: #666;
        }

        .requirement.met {
            color: #4CAF50;
        }

        .requirement.met::before {
            content: '✓ ';
            color: #4CAF50;
        }

        .requirement.not-met::before {
            content: '○ ';
            color: #666;
        }

        #message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }

        #message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        #message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
    </style>
</head>
<body>
<div class="main-content">
    <div class="password-container">
        <h1>Passwort ändern</h1>

        <form id="changePasswordForm">
            <div class="form-group">
                <label for="currentPassword">Aktuelles Passwort</label>
                <input type="password" id="currentPassword" name="currentPassword" required>
            </div>

            <div class="form-group">
                <label for="newPassword">Neues Passwort</label>
                <input type="password" id="newPassword" name="newPassword" required>
                <div class="password-strength" id="passwordStrength"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Passwort bestätigen</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>

            <div class="requirements">
                <strong>Passwort-Anforderungen:</strong>
                <ul>
                    <li class="requirement" id="req-length">Mindestens 8 Zeichen</li>
                    <li class="requirement" id="req-uppercase">Mindestens ein Großbuchstabe</li>
                    <li class="requirement" id="req-lowercase">Mindestens ein Kleinbuchstabe</li>
                    <li class="requirement" id="req-number">Mindestens eine Zahl</li>
                </ul>
            </div>

            <button type="submit" class="btn-primary">Passwort ändern</button>
        </form>

        <div id="message"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prüfen, ob der Benutzer eingeloggt ist
        checkLoginStatus();

        // Passwort-Stärke und Anforderungen in Echtzeit aktualisieren
        const newPasswordInput = document.getElementById('newPassword');
        newPasswordInput.addEventListener('input', updatePasswordRequirements);

        // Formular-Validierung und Absenden
        const changePasswordForm = document.getElementById('changePasswordForm');
        changePasswordForm.addEventListener('submit', handleFormSubmit);
    });

    // Prüfen, ob der Benutzer eingeloggt ist
    async function checkLoginStatus() {
        try {
            const response = await fetch('/api/session', {
                credentials: 'include'
            });
            const data = await response.json();

            if (!data.loggedIn) {
                // Benutzer ist nicht eingeloggt, zur Login-Seite weiterleiten
                window.location.href = '/login/login.html';
            }
        } catch (error) {
            console.error('Fehler beim Prüfen des Login-Status:', error);
            showMessage('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.', false);
        }
    }

    // Passwort-Anforderungen in Echtzeit aktualisieren
    function updatePasswordRequirements() {
        const password = document.getElementById('newPassword').value;
        const passwordStrength = document.getElementById('passwordStrength');

        // Anforderungen prüfen
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqNumber = document.getElementById('req-number');

        const hasMinLength = password.length >= 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /[0-9]/.test(password);

        // Status für jede Anforderung aktualisieren
        updateRequirementStatus(reqLength, hasMinLength);
        updateRequirementStatus(reqUppercase, hasUpperCase);
        updateRequirementStatus(reqLowercase, hasLowerCase);
        updateRequirementStatus(reqNumber, hasNumbers);

        // Passwort-Stärke berechnen
        let strength = 0;
        if (hasMinLength) strength++;
        if (hasUpperCase) strength++;
        if (hasLowerCase) strength++;
        if (hasNumbers) strength++;

        // Passwort-Stärke anzeigen
        passwordStrength.className = 'password-strength';
        if (password.length === 0) {
            passwordStrength.style.width = '0';
        } else if (strength <= 2) {
            passwordStrength.classList.add('weak');
        } else if (strength === 3) {
            passwordStrength.classList.add('medium');
        } else {
            passwordStrength.classList.add('strong');
        }
    }

    // Status einer Anforderung aktualisieren
    function updateRequirementStatus(element, isMet) {
        if (isMet) {
            element.classList.add('met');
            element.classList.remove('not-met');
        } else {
            element.classList.add('not-met');
            element.classList.remove('met');
        }
    }

    // Formular validieren und absenden
    async function handleFormSubmit(event) {
        event.preventDefault();

        // Formulardaten abrufen
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validierung der Passwörter
        if (newPassword !== confirmPassword) {
            showMessage('Die Passwörter stimmen nicht überein.', false);
            return;
        }

        // Anforderungen prüfen
        const hasMinLength = newPassword.length >= 8;
        const hasUpperCase = /[A-Z]/.test(newPassword);
        const hasLowerCase = /[a-z]/.test(newPassword);
        const hasNumbers = /[0-9]/.test(newPassword);

        if (!hasMinLength || !hasUpperCase || !hasLowerCase || !hasNumbers) {
            showMessage('Das neue Passwort erfüllt nicht alle Anforderungen.', false);
            return;
        }

        try {
            // Passwort ändern
            const response = await fetch('/api/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currentPassword,
                    newPassword
                }),
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                showMessage('Das Passwort wurde erfolgreich geändert!', true);
                document.getElementById('changePasswordForm').reset();
                document.getElementById('passwordStrength').className = 'password-strength';

                // Anforderungen zurücksetzen
                document.querySelectorAll('.requirement').forEach(req => {
                    req.classList.remove('met');
                    req.classList.add('not-met');
                });
            } else {
                showMessage(result.message || 'Fehler beim Ändern des Passworts.', false);
            }
        } catch (error) {
            console.error('Fehler beim Ändern des Passworts:', error);
            showMessage('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.', false);
        }
    }

    // Nachricht anzeigen
    function showMessage(text, isSuccess) {
        const messageElement = document.getElementById('message');
        messageElement.textContent = text;
        messageElement.className = isSuccess ? 'success' : 'error';
        messageElement.style.display = 'block';

        // Nach 5 Sekunden ausblenden, wenn es eine Erfolgsmeldung ist
        if (isSuccess) {
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    }
</script>
</body>
</html>

